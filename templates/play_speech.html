<!DOCTYPE html>
<html lang="{{ 'zh' if game.lang == 'zh' else 'en' }}">
<head>
  <meta charset="utf-8">
  <title>ğŸ¤ {{ 'å£è¯­æ¸¸æˆ' if game.lang == 'zh' else 'Speaking Game' }} â€“ {{ game.title }}</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/play_speech.css') }}">
</head>
<body>

<h2>{{ 'ğŸ¤ å£è¯­æ¸¸æˆ' if game.lang == 'zh' else 'ğŸ¤ à¹€à¸à¸¡à¸à¸¹à¸”' }}</h2>
<p>{{ game.description }}</p>

<div class="game-layout">
  <!-- à¸‹à¹‰à¸²à¸¢: à¸„à¸³à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸¹à¸” -->
  <div class="summary-box">
    <div class="q-text">{{ 'ğŸ“‹ éœ€è¦è¯´çš„å¥å­' if game.lang == 'zh' else 'ğŸ“‹ à¸„à¸³à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸¹à¸”à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”' }}</div>
    <ul id="summary-list">
      {% for q in questions %}
        <li>
          {{ q.correct_answer }}
          {% if game.lang == "zh" and pinyin_map.get(q.correct_answer) %}
            <div style="color:#888; font-size:0.9rem;">
              æ‹¼éŸ³ (Pinyin): {{ pinyin_map.get(q.correct_answer) }}
            </div>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>

  <!-- à¸‚à¸§à¸²: à¹€à¸à¸¡ -->
  <div class="game-container">
    {% for q in questions %}
      <div class="question" data-qid="{{ q.id }}">
        <div class="q-text">Q{{ loop.index }}: {{ q.question_text }}</div>
        <div class="answer-box" id="answer-{{ q.id }}">
          {{ 'è¿˜æ²¡æœ‰å›ç­”' if game.lang == 'zh' else '(à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸³à¸•à¸­à¸š)' }}
        </div>
        <button id="record-btn-{{ q.id }}" class="record-btn" onclick="toggleRecording({{ q.id }})">
          ğŸ™ï¸ {{ 'å¼€å§‹å½•éŸ³' if game.lang == 'zh' else 'à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸±à¸”à¹€à¸ªà¸µà¸¢à¸‡' }}
        </button>
        <div class="result" id="result-{{ q.id }}"></div>
        <div class="progress"><div class="bar" id="bar-{{ q.id }}"></div></div>
      </div>
    {% endfor %}
  </div>
</div>

<div id="btn-area" style="text-align:center; margin-top:20px;">
  <button id="finish-btn" onclick="submitFinal()">âœ… {{ 'æäº¤æˆç»©' if game.lang == 'zh' else 'à¸ªà¹ˆà¸‡à¸„à¸°à¹à¸™à¸™à¸£à¸§à¸¡' }}</button>
</div>

<script>
  const gameLang = "{{ game.lang }}";
  const PINYIN_MAP = {{ pinyin_map|tojson }};
  let answers = {};
  let scores = {};
  let recognition = null;
  let isRecording = false;


  function toggleRecording(qid) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert(gameLang === "zh"
        ? " è¯¥æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨ Chrome æµè§ˆå™¨ã€‚"
        : " à¹€à¸šà¸£à¸²à¸§à¹Œà¹€à¸‹à¸­à¸£à¹Œà¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š à¸à¸£à¸¸à¸“à¸²à¹ƒà¸Šà¹‰ Chrome à¸«à¸£à¸·à¸­ Edge");
      return;
    }

    const btn = document.getElementById("record-btn-" + qid);

    if (isRecording && recognition) {
      recognition.stop();
      isRecording = false;
      btn.innerHTML = "ğŸ™ï¸ " + (gameLang === "zh" ? "å¼€å§‹å½•éŸ³" : "à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸±à¸”à¹€à¸ªà¸µà¸¢à¸‡");
      return;
    }

    recognition = new SpeechRecognition();
    recognition.lang = (gameLang === "zh") ? "cmn-Hans-CN" : "en-US";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    btn.innerHTML = "â¹ï¸ " + (gameLang === "zh" ? "åœæ­¢å½•éŸ³" : "à¸«à¸¢à¸¸à¸”à¸­à¸±à¸”à¹€à¸ªà¸µà¸¢à¸‡");
    isRecording = true;
    recognition.start();

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript.trim();
      document.getElementById("answer-" + qid).innerText = transcript;
      answers[qid] = transcript;
    };

    recognition.onerror = (event) => {
      alert("âš ï¸ " + event.error);
      btn.innerHTML = "ğŸ™ï¸ " + (gameLang === "zh" ? "å¼€å§‹å½•éŸ³" : "à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸±à¸”à¹€à¸ªà¸µà¸¢à¸‡");
      isRecording = false;
      recognition = null;
    };

    recognition.onend = () => {
      btn.innerHTML = "ğŸ™ï¸ " + (gameLang === "zh" ? "å¼€å§‹å½•éŸ³" : "à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸±à¸”à¹€à¸ªà¸µà¸¢à¸‡");
      isRecording = false;
      recognition = null;
    };
  }

  
  function normalizeText(txt, lang="en"){
    let t = txt.trim();
    if(lang==="zh"){ t = t.replace(/[ã€‚ï¼Œï¼ï¼Ÿã€]/g,""); }
    else { t = t.toLowerCase().replace(/[.,!?]/g,""); }
    return t;
  }

  function levenshtein(a,b){
    const matrix=[]; const alen=a.length, blen=b.length;
    for(let i=0;i<=blen;i++) matrix[i]=[i];
    for(let j=0;j<=alen;j++) matrix[0][j]=j;
    for(let i=1;i<=blen;i++){
      for(let j=1;j<=alen;j++){
        if(b.charAt(i-1)===a.charAt(j-1)) matrix[i][j]=matrix[i-1][j-1];
        else matrix[i][j]=Math.min(matrix[i-1][j-1]+1, matrix[i][j-1]+1, matrix[i-1][j]+1);
      }
    }
    return matrix[blen][alen];
  }

  function similarity(a,b){
    const longer=a.length>b.length?a:b;
    const shorter=a.length>b.length?b:a;
    if(longer.length===0) return 0;
    const dist=levenshtein(longer,shorter);
    return (longer.length-dist)/longer.length;
  }


  function submitFinal() {
    scores = {};
    let results = [];

    {% for q in questions %}
      (function(){
        const qid = {{ q.id }};
        const transcript = answers[qid] || "";
        const correctAnswer = {{ q.correct_answer|tojson }};
        const correctPinyin = PINYIN_MAP[{{ q.correct_answer|tojson }}] || "";


        const normUser = normalizeText(transcript, gameLang);
        const normCorrect = normalizeText(correctAnswer, gameLang);
        const scoreRatio = similarity(normUser, normCorrect);
        const percent = Math.round(scoreRatio * 100);

        const resultDiv = document.getElementById("result-" + qid);
        let isCorrect = false;

        if (scoreRatio >= 0.8) {
          resultDiv.innerHTML = `<span class="correct">âœ… ${(gameLang==="zh")?"æ­£ç¡®":"à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡"}</span>
                                 <span style="color:#2e7d32;"> (${percent}%)</span>`;
          scores[qid] = 1;
          isCorrect = true;
        } else {
          resultDiv.innerHTML = `<span class="wrong">âŒ ${(gameLang==="zh")?"é”™è¯¯":"à¸œà¸´à¸”"}</span>
                                 <span style="color:#c62828;"> (${percent}%)</span><br>
                                 <small>
                                   ${(gameLang==="zh")?"æ­£ç¡®ç­”æ¡ˆ":"à¹€à¸‰à¸¥à¸¢"}: 
                                   ${correctAnswer}
                                   ${(gameLang==="zh" && correctPinyin) ? ` (${correctPinyin})` : ""}
                                 </small>`;
          scores[qid] = 0;
        }

        const bar = document.getElementById("bar-" + qid);
        bar.style.width = percent+"%";
        bar.textContent = percent+"%";
        bar.className = "bar " + (percent>=80?"green":percent>=51?"orange":"red");

        results.push({
          question_id: qid,
          spoken_text: transcript,
          expected: correctAnswer,
          similarity: scoreRatio,
          is_correct: isCorrect
        });
      })();
    {% endfor %}

    const total = Object.keys(scores).length;
    const score = Object.values(scores).reduce((a,b)=>a+b,0);

    
    fetch(`/game/speech_finish/{{ game.id }}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ score: score, total: total })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const finishBtn = document.getElementById("finish-btn");
        finishBtn.disabled = true;
        finishBtn.innerText = `âœ… ${(gameLang==="zh")?"å·²æäº¤":"à¸ªà¹ˆà¸‡à¹à¸¥à¹‰à¸§"}: ${(gameLang==="zh")?"æ€»åˆ†":"à¸„à¸°à¹à¸™à¸™à¸£à¸§à¸¡"} ${data.score}/${data.total}`;

        const backBtn = document.createElement("button");
        backBtn.innerText = (gameLang === "zh") ? "è¿”å›è¯¾ç¨‹é¡µé¢" : "à¸à¸¥à¸±à¸šà¹„à¸›à¸«à¸™à¹‰à¸²à¸šà¸—à¹€à¸£à¸µà¸¢à¸™";
        backBtn.classList.add("back-btn");
        backBtn.onclick = () => {
          window.location.href = "{{ url_for('student.lesson_score_detail_zh', lesson_id=game.lesson_id) if game.lang == 'zh' else url_for('student.lesson_score_detail', lesson_id=game.lesson_id) }}";
        };

        const btnContainer = document.createElement("div");
        btnContainer.style.display = "flex";
        btnContainer.style.justifyContent = "center";
        btnContainer.style.gap = "20px";
        btnContainer.style.marginTop = "20px";
        btnContainer.appendChild(backBtn);
        btnContainer.appendChild(finishBtn);

        const parentDiv = document.getElementById("btn-area");
        parentDiv.innerHTML = "";
        parentDiv.appendChild(btnContainer);
      } else {
        alert("âŒ " + (gameLang==="zh" ? "æäº¤å¤±è´¥" : "à¸šà¸±à¸™à¸—à¸¶à¸à¸œà¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ") + ": " + (data.message || ""));
      }
    })
    .catch(err => {
      console.error("âŒ speech_finish error:", err);
      alert(gameLang==="zh" ? "æäº¤æˆç»©æ—¶å‡ºé”™" : "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸„à¸°à¹à¸™à¸™");
    });
  }
</script>

</body>
</html>
